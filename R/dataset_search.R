# WARNING - Generated by {fusen} from dev/ridlle_dev.Rmd: do not edit by hand

#' Searches for datasets and resources satisfying a given criteria.
#'
#' @name search
#'
#' @param q,query The search query.
#' @param rows The maximum number of matching rows (datasets) to return. 
#'              (optional, default: 10, upper limit: 1000)
#' @param start The offset in the complete result for where the set of returned 
#'               datasets should begin.
#'
#' @importFrom purrr is_empty pmap
#' @importFrom tibble tibble
#' @importFrom tidyselect vars_select_helpers
#' @importFrom dplyr mutate across
#' 
#' @return A tibble with the search results.
#' @export
#' @examples
#' #-----
#' # Test search in prod
#' # Sys.unsetenv("USE_UAT")
#' # searching <- "cbi"
#' # p <- dataset_search(q = searching, rows = 30)
#' # p
#'
#'
#'
#' #-----
#' # Test create in UAT
#' Sys.setenv(USE_UAT=1)
#' # p2 <- dataset_search(q = "testedouard2")
#'
dataset_search <- function(q = NULL, 
                           rows = NULL, 
                           start = NULL) {
  search_result <- ridl(action ="package_search", 
                        q = q,
                        rows = rows
                        
      # This part construct an argument list for the ridl function. 
      # The triple-bang operator (!!!) is used to "unquote" the list, 
      # effectively passing its contents as separate arguments 
      # match.call()[-1]  extract the arguments passed to the current function 
      #      !!!(as.list(lapply(match.call()[-1], 
      #  turns the arguments into their actual values,
      # effectively unwrapping expressions that may have been passed as arguments.   
      #                        FUN = function(argument) { return(eval(argument))}
      #                        )) )
      )

  if (purrr::is_empty(search_result[["result"]])) {
    search_results <- tibble::tibble()

  } else {
    
    search_results <- search_result[["result"]][["results"]] %>%
      dplyr::mutate(dplyr::across(
        tidyselect::vars_select_helpers$where(is.data.frame),
        ~ purrr::pmap(., ~ tibble::tibble(...))
      )) %>%
      tibble::as_tibble() 
  }
  
  return(search_results)
}

