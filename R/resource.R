# WARNING - Generated by {fusen} from /dev/ridlle_dev.Rmd: do not edit by hand

#' Work with RIDL resources (files)
#'
#' @name resource
#' @details You must have the necessary permissions to create, edit, or delete datasets and their resources.
#'
#' Note that several fields are required for `resource_create()` and `resource_update()` operations to succeed. Consult \code{\link{resource_metadata()}} for the details.
#'
#' For `resource_update()`/`resource_patch()` operations, it is recommended to call `resource_show()`, make the desired changes to the result, and then call `resource_update()`/`resource_patch()` with it.
#'
#' The difference between the update and patch methods is that the patch will perform an update of the provided parameters, while leaving all other parameters unchanged, whereas the update methods deletes all parameters not explicitly provided in the `metadata`.
#'
#' @param metadata Metadata created by \code{\link{resource_metadata()}}.
#' @param id The id or name of the resource.
#' @param pkgid The id or name of the dataset to which this resource belongs to.
#'
#' @return The resource.
#' @export
#' @examples
#' library(riddle)
#' Sys.setenv(USE_UAT=1)
#' m <- dataset_metadata(title = "Motor Trend Car Road Tests",
#'                       name = "mtcars",
#'                       notes = "The data was extracted from the 1974 Motor Trend 
#'                       US magazine, and comprises fuel consumption and 10 aspects
#'                       of automobile design and performance for 32 automobiles 
#'                       (1973–74 models).",
#'                       owner_org = "exercise-container",
#'                       visibility = "public",
#'                       external_access_level = "open_access",
#'                       data_collector = "Motor Trend",
#'                       keywords = keywords[c("Environment", "Other")],
#'                       unit_of_measurement = "car",
#'                       data_collection_technique = "oth",
#'                       archived = "False")
#' 
#' p <- dataset_create(m)
#' m <- resource_metadata(type = "data",
#'                        url = "mtcars.csv",
#'                        name = "mtcars.csv",
#'                        format = "csv",
#'                        file_type = "microdata",
#'                        date_range_start = "1973-01-01",
#'                        date_range_end = "1973-12-31",
#'                        version = "1",
#'                        process_status = "raw",
#'                        identifiability = "anonymized_public")
#' r <- resource_create(p$id, m)
#' # Like before, the return value is a tibble representation of the
#' # resource.
#' 
#' r
#' 
#' # But so far we’ve only created the metadata for the resource. The next
#' # step is to upload the data.
#' resource_upload(r$id, path = system.file("extdata/mtcars.csv", package = "readr"))
#' 
#' resource_search("name:mtcars")
#' 
resource_create <- function(pkgid, metadata) {
  enc <- if(is.null(metadata$upload)) "json" else "multipart"
  ridl("resource_create", dataset_id = pkgid, !!!metadata, .encoding = enc) %>% resource_tibblify()
}

#' @rdname resource
#' @export
resource_update <- function(id, metadata) {
  enc <- if(is.null(metadata$upload)) "json" else "multipart"
  ridl("resource_update", id = id, !!!metadata, .encoding = enc) %>% resource_tibblify()
}

#' @rdname resource
#' @export
resource_patch <- function(id, metadata) {
  enc <- if(is.null(metadata$upload)) "json" else "multipart"
  ridl("resource_patch", id = id, !!!metadata, .encoding = enc) %>% resource_tibblify()
}

#' @rdname resource
#' @export
resource_delete <- function(id) { ridl("resource_delete", id = id) }

#' @rdname search
#' @export
resource_search <- function(query = NULL, rows = NULL, start = NULL) {
  ridl("resource_search", !!!(as.list(match.call()[-1])))$results %>% tibble::as_tibble()
}

#' Fetch resource from RIDL
#' @param url The URL of the resource to fetch
#' @param path Location to store the resource
#'
#' @return Path to the downloaded file
#' @export
resource_fetch <- function(url, path = tempfile()) {
  httr::GET(url,
            httr::add_headers("X-CKAN-API-Key" = Sys.getenv("RIDL_API_KEY")),
            httr::write_disk(path))

  path
}

