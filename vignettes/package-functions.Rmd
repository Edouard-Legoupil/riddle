---
title: "Package Functions"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{package-functions}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(riddle)
```

<!-- WARNING - This vignette is generated by {fusen} from /dev/ridlle_dev.Rmd: do not edit by hand -->

# ridl

    

  

```{r example-ridl}
# ridl(action ="package_search", as.list("cbi"))
```

  

# dataset_metadata

  

```{r example-dataset_metadata}
m <- dataset_metadata(title = "Motor Trend Car Road Tests",
                      name = "mtcars",
                      notes = "The data was extracted from the 1974 Motor Trend 
                      US magazine, and comprises fuel consumption and 10 aspects
                      of automobile design and performance for 32 automobiles 
                      (1973–74 models).",
                      owner_org = "exercise-container",
                      visibility = "public",
                      geographies = "UNSPECIFIED",
                      external_access_level = "open_access",
                      data_collector = "Motor Trend",
                      keywords = keywords[c("Environment", "Other")],
                      unit_of_measurement = "car",
                      data_collection_technique = "oth",
                      archived = "False")

m
```

  

# dataset_tibblify

    

  

```{r example-dataset_tibblify}
m <- dataset_metadata(title = "Motor Trend Car Road Tests",
                      name = "mtcars",
                      notes = "The data was extracted from the 1974 Motor Trend 
                      US magazine, and comprises fuel consumption and 10 aspects
                      of automobile design and performance for 32 automobiles 
                      (1973–74 models).",
                      owner_org = "exercise-container",
                      visibility = "public",
                      geographies = "UNSPECIFIED",
                      external_access_level = "open_access",
                      data_collector = "Motor Trend",
                      keywords = keywords[c("Environment", "Other")],
                      unit_of_measurement = "car",
                      data_collection_technique = "oth",
                      archived = "False")

m1 <- dataset_tibblify(m)
m1
```

  

# dataset

  

```{r example-dataset}


#-----
# test search in prod
Sys.unsetenv("USE_UAT")
#Sys.setenv(USE_UAT=0)
# riddle::dataset_show(id = "unhcr-cbi-americas-quarterly-report")
# 
# p <- riddle::dataset_show('rms_v4')
# list_of_ressources <- p[["resources"]][[1]]
# list_of_ressources



#-----
# Test create in UAT
Sys.setenv(USE_UAT=1)

# p <- riddle::dataset_show('testedouard2')

### TO FIX -- geographies: Missing value
## __type: Validation Error ---
## cf https://github.com/okfn/ckanext-unhcr/blob/master/ckanext/unhcr/schemas/dataset.json#L670:L682

m <- riddle::dataset_metadata(title = "Motor Trend Car Road Test two",
                      name = "mtcars_ed",
                      notes = "The data was extracted from the 1974 Motor Trend
                      US magazine, and comprises fuel consumption and 10 aspects
                      of automobile design and performance for 32 automobiles
                      (1973–74 models).",
                      owner_org = "Americas",
                      visibility = "public",
                      geographies = "UNSPECIFIED",
                      external_access_level = "open_access",
                      data_collector = "Motor Trend",
                      keywords = keywords[c("Environment", "Other")],
                      unit_of_measurement = "car",
                      data_collection_technique = "oth",
                      archived = "False")
# ## For the above to work - you need to make sure you have at least editor access
# to the corresponding container - i.e. owner_org = "exercise-container"
#p <- riddle::dataset_create(metadata = m)
# The return value is a representation of the dataset we just created in
# RIDL that you could inspect like any other R object.
#p

#-----
# Test create in prod
Sys.unsetenv("USE_UAT")
# m1 <- riddle::dataset_metadata(title = "Test",
#                       name = "Test",
#                       notes = "The data was extracted from kobo.",
#                       owner_org = "Americas : Regional Datasets",
#                       visibility = "public",
#                       geographies = "UNSPECIFIED",
#                       external_access_level = "open_access",
#                       data_collector = "UNHCR",
#                       keywords = keywords[c("Environment", "Other")],
#                       unit_of_measurement = "car",
#                       data_collection_technique = "oth",
#                       archived = "False")
# p <- riddle::dataset_create(metadata = m1)


```

  

  

# dataset_search

    

  

```{r example-dataset_search}
#-----
# Test search in prod
Sys.unsetenv("USE_UAT")
# p <- dataset_search(q = "cbi")
# p



#-----
# Test create in UAT
Sys.setenv(USE_UAT=1)
#p2 <- dataset_search(q = "testedouard2")

```

  

  

# resource_metadata

  

```{r example-resource_metadata}
#resource_metadata()
m <- riddle::resource_metadata(type = "data",
                       url = "mtcars.csv",
                       name = "mtcars.csv",
                       format = "csv",
                       file_type = "microdata",
                       date_range_start = "1973-01-01",
                       date_range_end = "1973-12-31",
                       version = "1",
                       visibility = "public",
                       process_status = "raw",
                       identifiability = "anonymized_public")
m
```

  

# resource_tibblify

    

  

```{r example-resource_tibblify}
m <- riddle::resource_metadata(type = "data",
                       url = "mtcars.csv",
#  upload = httr::upload_file(system.file("extdata/mtcars.csv", package = "readr")),
## # Error:
# ! All columns in a tibble must be vectors.
# ✖ Column `upload` is a `form_file` object.
                       name = "mtcars.csv",
                       format = "csv",
                       file_type = "microdata",
                       date_range_start = "1973-01-01",
                       date_range_end = "1973-12-31",
                       version = "1",
                       visibility = "public",
                       process_status = "raw",
                       identifiability = "anonymized_public")

m1 <- riddle::resource_tibblify(m)



m1
```

  

  



# resource

  

```{r example-resource}
## let's get again the details of the dataset we want to add the resource in..
#-----
# Test search in prod
Sys.unsetenv("USE_UAT")
# p <- riddle::dataset_search("rms_v4")
# p

#-----
# Test search in uat
Sys.setenv(USE_UAT=1)
# p <- riddle::dataset_search("tests")
# p
# ##take the first one
# ridlid <- as.character(p[9, c("id")])




#-----
# Test search in prod
Sys.unsetenv("USE_UAT")
# p <- riddle::dataset_show('rms_v4')
# dataset_id_rms <- p$id
# list_of_ressources <- p[["resources"]][[1]]
# knitr::kable(list_of_ressources)

new_attachment <- riddle::resource_metadata(type = "attachment",
                       url = "resource.R", 
# upload = httr::upload_file(here::here("R","resource.R") ),
## # Error:
# ! All columns in a tibble must be vectors.
# ✖ Column `upload` is a `form_file` object.
                       name = "Rscript",
                       format = "R",
                       file_type = "report",
                       version = "1",
                       visibility = "public" )

## Now testing adding the file "resource.R" as an attachment in the 
## dataset 'rms_v4'

# but not working.... 
# resource_create(dataset_id = dataset_id_rms, 
#                         res_metadata = new_attachment )
# Error in ridl(action = "resource_create", dataset_id = dataset_id, !!!res_metadata, : 
# __type: Not Found Error
# message: Not found: No dataset id provided, cannot check auth.

m <- riddle::resource_metadata(type = "data",
                       url = "mtcars.csv",
  upload = httr::upload_file(system.file("extdata/mtcars.csv", package = "readr")),         

                       name = "mtcars.csv",
                       format = "csv",
                       file_type = "microdata",
                       date_range_start = "1973-01-01",
                       date_range_end = "1973-12-31",
                       version = "1",
                       visibility = "public",
                       process_status = "raw",
                       identifiability = "anonymized_public")
# same pb... 
# resource_create(dataset_id = dataset_id_rms, 
#                          res_metadata = m )
# Error in ridl(action = "resource_create", dataset_id = dataset_id, !!!res_metadata, : 
# __type: Not Found Error
# message: Not found: No dataset id provided, cannot check auth.

## let's get again the details of the dataset we want to add the resource in..
#r <- riddle::resource_create(dataset_id = ridlid, res_metadata = m)
# Like before, the return value is a tibble representation of the resource.
#r
 
## and now can search for it - checking it is correctly there... 
##riddle::resource_search("name:mtcarsriddle")

# And once we’re done experimenting with the API, we should take down our
# toy dataset since we don’t really need it on RIDL.
#riddle::dataset_delete(p$id)
# riddle::resource_delete()

```

  

# resource_fetch

    

  

```{r example-resource_fetch}
#-----
# Test search in prod
#Sys.unsetenv("USE_UAT")


## Example 1: with a direct URL
# resource_fetch(url = 'https://ridl.unhcr.org/dataset/a60f4b79-8acc-4893-8fb9-d52f94416b19/resource/daa2b9e4-bf97-4302-86a5-08bb62a5a937/download/df_age_2022.csv',
#                        path = tempfile())

## Example 2: Let's try to identify a resource - then fetch it locally and update it back... as from here
# https://github.com/unhcr-americas/darien_gap_human_mobility/blob/main/report.Rmd#L38

# p <- riddle::dataset_show('rms_v4')
# ## let's get the fifth resource
# test_ressources <- p[["resources"]][[1]] |> dplyr::slice(5)
#
# ## Get the resource locally..
#resource_fetch(url = test_ressources$url,   path =  here::here("file"))
#
# # Rebuild the metadata
# m <- resource_metadata(type = test_ressources$type, #"data",
#                          url = "df_gender_2020.csv",
# upload = httr::upload_file(here::here("data.csv")),
# ## # Error:
# # ! All columns in a tibble must be vectors.
# # ✖ Column `upload` is a `form_file` object.
#                          name = test_ressources$name, # "Irregular entries by gender in 2022",
#                          format = test_ressources$format, #"csv",
#                          file_type =  test_ressources$file_type, #"microdata",
#                          visibility = test_ressources$visibility, # "public",
#                          date_range_start =  test_ressources$date_range_start, # "2022-01-01",
#                          date_range_end = test_ressources$date_range_end, #as.character(floor_date(today('America/Panama'), "month") - days(1)), #end day of last month
#                          version = test_ressources$version, # "0",
#                          process_status = test_ressources$process_status, #"anonymized",
#                          identifiability = test_ressources$identifiability, #"anonymized_public"
#   )

## Update back -- Does not work...
#r <- resource_update(id = test_ressources$id,  res_metadata = m)
### Error when using the upload...
# No encoding supplied: defaulting to UTF-8.
# Error in !r$success : invalid argument type

```

  

  


# summary_report

    

  

```{r example-summary_report}
# summary_report(year = 2022,
#                                    region = "Americas")
```

  

      



